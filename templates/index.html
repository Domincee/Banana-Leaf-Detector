<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Banana Leaf Disease Detector | AI-Powered</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="/static/styles.css">

  <script>
    function scrollToTool() {
      document.getElementById('upload-tool').scrollIntoView({ behavior: 'smooth' });
    }
  </script>
</head>

<body>

  <!-- HERO SECTION -->
  <section class="hero-section">
    <div class="hero-content">
      <span class="badge">üå± AI-Powered Agriculture</span>
      <h1>Protect Your <span class="highlight">Banana Crops</span> with Intelligence</h1>
      <p>Instant disease detection using advanced machine learning. Accurate, fast, and constantly learning from your
        feedback.</p>
      <button onclick="scrollToTool()" class="cta-button">Start Diagnosis</button>
    </div>
    <div class="hero-background"></div>
  </section>

  <!-- ORIGINAL TOOL LAYOUT -->
  <div id="upload-tool" class="container">
    <header>
      <h1>üçÉ Banana Leaf Detector</h1>
      <p class="subtitle">AI-Powered Plant Health Analysis</p>
    </header>

    <div class="main-content">
      <!-- CARD 1: UPLOAD -->
      <div class="card upload-section">
        <h2>Upload Image</h2>
        <form id="uploadForm" novalidate>
          <div class="upload-zone" id="uploadZone">
            <div class="upload-icon">üì∏</div>
            <p><strong>Click to upload</strong> or drag and drop</p>
            <p style="font-size: 0.9em; color: #7f8c8d; margin-top: 10px;">Supports: JPG, PNG, WEBP</p>
          </div>
          <!-- IMPORTANT: name="image" to match app.py -->
          <input type="file" id="imageInput" name="image" accept="image/*">
          <img id="preview" alt="Image preview">
          <button type="submit" id="submitBtn">Analyze Leaf</button>
        </form>

        <div class="progress-steps" id="progressSteps">
          <div class="step" id="step1"><span class="step-icon">‚¨ÜÔ∏è</span><span>Uploading image...</span></div>
          <div class="step" id="step2"><span class="step-icon">üîç</span><span>Analyzing features...</span></div>
          <div class="step" id="step3"><span class="step-icon">ü§ñ</span><span>Running AI model...</span></div>
          <div class="step" id="step4"><span class="step-icon">‚úÖ</span><span>Generating results...</span></div>
        </div>
      </div>

      <!-- CARD 2: RESULTS -->
      <div class="card results-section">
        <h2>Analysis Results</h2>
        <div id="output">
          <div class="empty-state">
            <p>üìä</p>
            <p>Upload an image to see analysis results</p>
          </div>
        </div>
      </div>
      <!-- CARD 3: HISTORY -->
      <div class="card history-section">
        <div class="history-header">
          <h2>üìú Analysis History</h2>
          <button class="clear-history-btn" onclick="clearHistory()" title="Clear History">üóëÔ∏è Clear</button>
        </div>
        <div class="history-grid">
          <!-- COLUMN 1: ACCURATE -->
          <div class="history-col">
            <h3 class="col-header header-correct">‚úÖ Accurate</h3>
            <div id="colAccurate" class="history-col-list"></div>
          </div>

          <!-- COLUMN 2: INCORRECT -->
          <div class="history-col">
            <h3 class="col-header header-incorrect">‚ùå Incorrect</h3>
            <div id="colIncorrect" class="history-col-list"></div>
          </div>

          <!-- COLUMN 3: CORRECTED -->
          <div class="history-col">
            <h3 class="col-header header-corrected">üü† Corrected</h3>
            <div id="colCorrected" class="history-col-list"></div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Script Restored -->
  <script>
    const uploadForm = document.getElementById('uploadForm');
    const imageInput = document.getElementById('imageInput');
    const uploadZone = document.getElementById('uploadZone');
    const preview = document.getElementById('preview');
    const output = document.getElementById('output');
    const progressSteps = document.getElementById('progressSteps');
    const submitBtn = document.getElementById('submitBtn');

    let currentServerFilename = null;
    let historyData = [];

    // Load history on start
    loadHistory();

    // Drag and Drop
    ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
      uploadZone.addEventListener(eventName, preventDefaults, false);
    });

    function preventDefaults(e) {
      e.preventDefault();
      e.stopPropagation();
    }

    ['dragenter', 'dragover'].forEach(eventName => {
      uploadZone.addEventListener(eventName, () => uploadZone.classList.add('dragover'), false);
    });

    ['dragleave', 'drop'].forEach(eventName => {
      uploadZone.addEventListener(eventName, () => uploadZone.classList.remove('dragover'), false);
    });

    uploadZone.addEventListener('drop', handleDrop, false);

    function handleDrop(e) {
      const dt = e.dataTransfer;
      const files = dt.files;
      handleFiles(files);
    }

    uploadZone.addEventListener('click', () => imageInput.click());
    imageInput.addEventListener('change', () => handleFiles(imageInput.files));

    function handleFiles(files) {
      if (files.length > 0) {
        const file = files[0];
        // Assign to input for form submission
        imageInput.files = files; // Essential for FormData

        const reader = new FileReader();
        reader.onload = function (e) {
          preview.src = e.target.result;
          preview.style.display = 'block';
        }
        reader.readAsDataURL(file);
      }
    }

    uploadForm.addEventListener('submit', async (e) => {
      e.preventDefault();

      if (!imageInput.files.length) {
        alert("Please select a file first!");
        return;
      }

      const formData = new FormData(uploadForm);
      // formData will automatically contain 'image' because input has name="image"

      // UI Reset
      output.innerHTML = '<div class="empty-state"><p>‚è≥ Processing...</p></div>';
      progressSteps.style.display = 'block';
      submitBtn.disabled = true;

      updateStep(1);

      try {
        updateStep(2); // Mock progress for steps

        const response = await fetch('/upload', {
          method: 'POST',
          body: formData
        });

        updateStep(3);

        const data = await response.json();

        updateStep(4);
        setTimeout(() => progressSteps.style.display = 'none', 1000); // Hide after success
        submitBtn.disabled = false;

        if (data.success) {
          currentServerFilename = data.filename;
          displayResult(data);
        } else {
          output.innerHTML = `<div class="result-item" style="color:red">Error: ${data.error}</div>`;
        }
      } catch (error) {
        console.error(error);
        submitBtn.disabled = false;
        output.innerHTML = `<div class="result-item" style="color:red">Network Error</div>`;
      }
    });

    function updateStep(stepNum) {
      document.querySelectorAll('.step').forEach((el, index) => {
        if (index + 1 === stepNum) el.classList.add('active');
      });
    }

    function displayResult(data) {
      const maxProb = Math.max(...Object.values(data.probabilities));
      const color = maxProb > 80 ? '#27ae60' : (maxProb > 50 ? '#f39c12' : '#c0392b');

      // Generate secondary probabilities text
      let othersHtml = '';
      const others = Object.entries(data.probabilities)
        .filter(([label, prob]) => label !== data.prediction && prob > 0)
        .map(([label, prob]) => `${label}: ${prob}%`);

      if (others.length > 0) {
        othersHtml = `<p style="font-size:0.9em; color:#7f8c8d; margin-top:5px;">Other possibilities: ${others.join(', ')}</p>`;
      }

      let html = `
                <div class="result-item">
                    <h3>Prediction: <span style="color:${color}">${data.prediction}</span></h3>
                    <div class="confidence-bar">
                        <div class="confidence-fill" style="width:${maxProb}%; background-color:${color}"></div>
                    </div>
                    <p>Confidence: ${maxProb}%</p>
                    ${othersHtml}
                    ${data.explanation ? `<div style="margin-top:10px; padding:10px; background:#eef; border-radius:5px;"><small>${data.explanation}</small></div>` : ''}
                    
                    <!-- FEEDBACK SECTION -->
                    <div id="feedbackSection" class="feedback-section">
                        <p>Was this correct?</p>
                        <div class="feedback-buttons">
                            <button class="feedback-btn yes" onclick="sendFeedback(true)">üëç Yes</button>
                            <button class="feedback-btn no" onclick="showCorrectionUI()">üëé No</button>
                        </div>
                        <div id="correctionUI" class="correction-ui hidden" style="display:none"> <!-- hidden class manual style -->
                             <p>Please select correct label:</p>
                             <div class="pill-labels">
                                <button class="pill-btn" onclick="submitCorrection('Healthy Leaf')">Healthy Leaf</button>
                                <button class="pill-btn" onclick="submitCorrection('Unhealthy leaf')">Unhealthy Leaf</button>
                                <button class="pill-btn" onclick="submitCorrection('Non-Leaf')">Non-Leaf</button>
                             </div>
                        </div>
                        <p id="feedbackMessage" style="margin-top:10px; font-weight:bold;"></p>
                    </div>
                </div>
            `;
      output.innerHTML = html;
    }

    // GLOBAL FEEDBACK FUNCTIONS (Attached to window for inline onclick)
    window.sendFeedback = function (isCorrect) {
      submitFeedbackPaylod(isCorrect, null);
    };

    window.showCorrectionUI = function () {
      document.getElementById('correctionUI').style.display = 'block';
    };

    window.submitCorrection = function (label) {
      submitFeedbackPaylod(false, label);
    };

    async function submitFeedbackPaylod(isCorrect, actualLabel) {
      if (!currentServerFilename) return;
      const msgEl = document.getElementById('feedbackMessage');
      msgEl.innerText = "Submitting feedback...";

      const predEl = document.querySelector('.result-item h3 span');
      const currentPred = predEl ? predEl.innerText : "unknown";

      try {
        const payload = {
          filename: currentServerFilename,
          prediction: currentPred,
          correct: isCorrect,
          actual_label: actualLabel
        };

        const res = await fetch('/feedback', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });

        const data = await res.json();
        if (data.success) {
          msgEl.innerText = "Thanks! Model retrained successfully üß†‚úÖ";
          msgEl.style.color = "green";
          document.getElementById('correctionUI').style.display = 'none';
          // Disable buttons
          document.querySelectorAll('.feedback-btn').forEach(btn => btn.disabled = true);

          // Reload History
          setTimeout(loadHistory, 1000);

        } else {
          msgEl.innerText = "Error: " + data.error;
          msgEl.style.color = "red";
        }
      } catch (e) {
        console.error(e);
        msgEl.innerText = "Network error.";
      }
    }

    // --- HISTORY FUNCTIONS ---
    async function loadHistory() {
      try {
        const res = await fetch('/history');
        historyData = await res.json();
        renderHistory();
      } catch (e) {
        console.error("History load error", e);
      }
    }

    async function clearHistory() {
      if (!confirm("Are you sure you want to clear the history? This cannot be undone.")) return;

      try {
        const res = await fetch('/clear_history', { method: 'POST' });
        const data = await res.json();
        if (data.success) {
          historyData = [];
          renderHistory();
        } else {
          alert("Failed to clear history: " + data.error);
        }
      } catch (e) {
        alert("Network error");
      }
    }

    function renderHistory() {
      const colAccurate = document.getElementById('colAccurate');
      const colIncorrect = document.getElementById('colIncorrect');
      const colCorrected = document.getElementById('colCorrected');

      // Clear columns
      colAccurate.innerHTML = '';
      colIncorrect.innerHTML = '';
      colCorrected.innerHTML = '';

      if (historyData.length === 0) {
        colAccurate.innerHTML = '<div class="empty-history">No history.</div>';
        return;
      }

      historyData.forEach(item => {
        const date = new Date(item.timestamp).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });

        const div = document.createElement('div');
        div.className = 'history-card-item';

        // Image path (handle legacy items without unique filenames gracefully-ish, though they won't exist in static/uploads so onerror hides them)
        const imgPath = `/static/uploads/${item.filename}`;

        let listContent = `
                <div class="h-layout">
                    <img src="${imgPath}" class="h-thumb" onerror="this.style.display='none'">
                    <div class="h-info">
                        <div class="h-meta">${date}</div>
                        <div class="h-pred"><strong>${item.prediction}</strong></div>
            `;

        if (item.status === 'correct') {
          // No additional content needed for 'correct'
        } else if (item.status === 'corrected') {
          listContent += `<div class="h-arrow">corrected to</div><div class="h-actual">${item.actual}</div>`;
        } else { // item.status === 'incorrect'
          // No additional content needed for 'incorrect'
        }
        // Close h-info and h-layout once after conditional content
        listContent += `</div></div>`;

        div.innerHTML = listContent;

        if (item.status === 'correct') {
          colAccurate.appendChild(div);
        } else if (item.status === 'corrected') {
          colCorrected.appendChild(div);
        } else { // item.status === 'incorrect'
          colIncorrect.appendChild(div);
        }
      });
    }
  </script>
</body>

</html>